<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Message Sync</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            width: 45%;
        }
        .message {
            background-color: #f0f0f0;
            padding: 5px;
            margin: 5px 0;
        }
        button {
            margin: 5px;
            padding: 8px 15px;
        }
    </style>
</head>
<body>
    <h1>Test Cross-Window Message Synchronization</h1>
    
    <div class="test-container">
        <div class="panel">
            <h3>Window A (Primary)</h3>
            <div id="messages-a" class="messages"></div>
            <input type="text" id="input-a" placeholder="Enter message for Window A">
            <button onclick="sendMessageA()">Send to A</button>
            <button onclick="openWindowB()">Open Window B</button>
            <button onclick="clearMessagesA()">Clear A</button>
        </div>
        
        <div class="panel">
            <h3>Window B (Secondary)</h3>
            <div id="messages-b" class="messages"></div>
            <input type="text" id="input-b" placeholder="Enter message for Window B">
            <button onclick="sendMessageB()">Send to B</button>
            <button onclick="clearMessagesB()">Clear B</button>
        </div>
    </div>
    
    <div>
        <h3>Browser Support Info:</h3>
        <div id="support-info"></div>
    </div>

    <script>
        // Test BroadcastChannel and localStorage synchronization
        let broadcastChannel = null;
        let windowB = null;
        let messagesA = [];
        let messagesB = [];

        // Display browser support info
        document.getElementById('support-info').innerHTML = `
            <p>BroadcastChannel supported: ${!!window.BroadcastChannel}</p>
            <p>localStorage supported: ${!!window.localStorage}</p>
        `;

        // Initialize BroadcastChannel
        if (typeof BroadcastChannel !== 'undefined') {
            broadcastChannel = new BroadcastChannel('test-sync-channel');
            
            broadcastChannel.onmessage = function(event) {
                const { type, message, sender } = event.data;
                
                if (type === 'testMessage') {
                    const timestamp = new Date().toLocaleTimeString();
                    const fullMessage = `[${timestamp}] From ${sender}: ${message}`;
                    
                    // Add to both windows' message arrays
                    messagesA.push(fullMessage);
                    messagesB.push(fullMessage);
                    
                    // Update both UIs
                    updateMessagesA();
                    updateMessagesB();
                    
                    console.log('Received broadcast message:', fullMessage);
                }
            };
            
            console.log('BroadcastChannel initialized');
        } else {
            console.log('BroadcastChannel not supported, using localStorage fallback');
            
            // Set up localStorage event listener as fallback
            window.addEventListener('storage', function(event) {
                if (event.key === 'test-sync-data' && event.newValue) {
                    try {
                        const data = JSON.parse(event.newValue);
                        if (data.type === 'testMessage') {
                            const timestamp = new Date().toLocaleTimeString();
                            const fullMessage = `[${timestamp}] From ${data.sender}: ${data.message}`;
                            
                            // Add to both windows' message arrays
                            messagesA.push(fullMessage);
                            messagesB.push(fullMessage);
                            
                            // Update both UIs
                            updateMessagesA();
                            updateMessagesB();
                            
                            console.log('Received localStorage sync message:', fullMessage);
                        }
                    } catch (e) {
                        console.error('Error parsing localStorage sync data:', e);
                    }
                }
            });
        }

        function updateMessagesA() {
            const container = document.getElementById('messages-a');
            container.innerHTML = messagesA.map(msg => `<div class="message">${msg}</div>`).join('');
        }

        function updateMessagesB() {
            const container = document.getElementById('messages-b');
            container.innerHTML = messagesB.map(msg => `<div class="message">${msg}</div>`).join('');
        }

        function sendMessageA() {
            const input = document.getElementById('input-a');
            const message = input.value.trim();
            
            if (message) {
                const timestamp = new Date().toLocaleTimeString();
                const fullMessage = `[${timestamp}] From A: ${message}`;
                
                messagesA.push(fullMessage);
                updateMessagesA();
                
                // Send via BroadcastChannel if available, otherwise localStorage
                if (broadcastChannel) {
                    broadcastChannel.postMessage({
                        type: 'testMessage',
                        message: message,
                        sender: 'Window A'
                    });
                } else {
                    // Use localStorage + storage event fallback
                    const syncData = {
                        type: 'testMessage',
                        message: message,
                        sender: 'Window A',
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('test-sync-data', JSON.stringify(syncData));
                    setTimeout(() => {
                        localStorage.removeItem('test-sync-data');
                    }, 100);
                }
                
                input.value = '';
            }
        }

        function sendMessageB() {
            const input = document.getElementById('input-b');
            const message = input.value.trim();
            
            if (message) {
                const timestamp = new Date().toLocaleTimeString();
                const fullMessage = `[${timestamp}] From B: ${message}`;
                
                messagesB.push(fullMessage);
                updateMessagesB();
                
                // Send via BroadcastChannel if available, otherwise localStorage
                if (broadcastChannel) {
                    broadcastChannel.postMessage({
                        type: 'testMessage',
                        message: message,
                        sender: 'Window B'
                    });
                } else {
                    // Use localStorage + storage event fallback
                    const syncData = {
                        type: 'testMessage',
                        message: message,
                        sender: 'Window B',
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('test-sync-data', JSON.stringify(syncData));
                    setTimeout(() => {
                        localStorage.removeItem('test-sync-data');
                    }, 100);
                }
                
                input.value = '';
            }
        }

        function clearMessagesA() {
            messagesA = [];
            updateMessagesA();
        }

        function clearMessagesB() {
            messagesB = [];
            updateMessagesB();
        }

        function openWindowB() {
            // Open a new window for testing
            windowB = window.open('test_sync.html', 'window_b', 'width=600,height=600');
        }

        // Handle Enter key for inputs
        document.getElementById('input-a').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageA();
            }
        });

        document.getElementById('input-b').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageB();
            }
        });
    </script>
</body>
</html>